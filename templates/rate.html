<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Design Tinder - Rate</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="progress">
                <span id="progress-text">Loading...</span>
            </div>
            <nav>
                <a href="/review">Review All →</a>
            </nav>
        </div>

        <div class="image-container">
            <img id="current-image" src="" alt="Design image">
            <div id="current-rating" class="current-rating"></div>
        </div>

        <div class="controls">
            <div class="navigation">
                <button id="prev-btn" class="nav-btn">← Previous</button>
                <button id="next-btn" class="nav-btn">Next →</button>
            </div>

            <div class="rating-buttons">
                <button class="rating-btn a" data-rating="a">
                    <kbd>A</kbd> A
                </button>
                <button class="rating-btn b" data-rating="b">
                    <kbd>B</kbd> B
                </button>
                <button class="rating-btn c" data-rating="c">
                    <kbd>C</kbd> C
                </button>
                <button class="rating-btn d" data-rating="d">
                    <kbd>D</kbd> D
                </button>
                <button class="rating-btn f" data-rating="f">
                    <kbd>F</kbd> F
                </button>
                <button class="rating-btn skip" id="skip-btn">
                    <kbd>;</kbd> Skip
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentIndex = 0;
        let totalImages = 0;

        async function loadImage(index) {
            try {
                const response = await fetch(`/api/images/current?index=${index}`);
                const data = await response.json();

                currentIndex = data.index;
                totalImages = data.total;

                document.getElementById('current-image').src = `/images/${data.filename}`;
                updateProgress();
                updateCurrentRating(data.rating);
            } catch (error) {
                console.error('Error loading image:', error);
            }
        }

        async function loadNextUnrated() {
            try {
                const response = await fetch('/api/images/next');
                const data = await response.json();

                currentIndex = data.index;
                totalImages = data.total;

                document.getElementById('current-image').src = `/images/${data.filename}`;
                updateProgress();
                updateCurrentRating(data.rating);
            } catch (error) {
                console.error('Error loading next image:', error);
            }
        }

        async function updateProgress() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                document.getElementById('progress-text').textContent =
                    `${stats.rated}/${stats.total} rated (${currentIndex + 1}/${totalImages})`;
            } catch (error) {
                console.error('Error updating progress:', error);
            }
        }

        function updateCurrentRating(rating) {
            const ratingDiv = document.getElementById('current-rating');
            if (rating) {
                ratingDiv.textContent = `Current: ${rating.toUpperCase()}`;
                ratingDiv.className = `current-rating ${rating}`;
                ratingDiv.style.display = 'block';
            } else {
                ratingDiv.style.display = 'none';
            }
        }

        async function updateRating(filename, rating) {
            await fetch(`/api/images/${filename}/rate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating })
            });
        }

        async function handleRating(rating, options = {}) {
            try {
                const imgSrc = document.getElementById('current-image').src;
                const filename = imgSrc.split('/').pop();

                // Update API
                await updateRating(filename, rating);

                // Update UI
                updateCurrentRating(rating);
                await updateProgress();

                // Execute callback if provided
                if (options.onComplete) {
                    await options.onComplete();
                }
            } catch (error) {
                console.error('Error rating image:', error);
            }
        }

        function navigatePrev() {
            if (currentIndex > 0) {
                loadImage(currentIndex - 1);
            }
        }

        function navigateNext() {
            if (currentIndex < totalImages - 1) {
                loadImage(currentIndex + 1);
            }
        }

        async function skip() {
            await handleRating(null, {
                onComplete: navigateNext
            });
        }

        // Event listeners for buttons
        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const rating = btn.dataset.rating;
                if (rating) {
                    await handleRating(rating, {
                        onComplete: loadNextUnrated
                    });
                }
            });
        });

        document.getElementById('skip-btn').addEventListener('click', skip);
        document.getElementById('prev-btn').addEventListener('click', navigatePrev);
        document.getElementById('next-btn').addEventListener('click', navigateNext);

        // Keyboard shortcuts
        document.addEventListener('keydown', async (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key.toLowerCase()) {
                case 'a':
                    await handleRating('a', { onComplete: loadNextUnrated });
                    break;
                case 'b':
                    await handleRating('b', { onComplete: loadNextUnrated });
                    break;
                case 'c':
                    await handleRating('c', { onComplete: loadNextUnrated });
                    break;
                case 'd':
                    await handleRating('d', { onComplete: loadNextUnrated });
                    break;
                case 'f':
                    await handleRating('f', { onComplete: loadNextUnrated });
                    break;
                case ';':
                    skip();
                    break;
                case 'arrowleft':
                    navigatePrev();
                    break;
                case 'arrowright':
                    navigateNext();
                    break;
            }
        });

        // Load first unrated image on page load
        loadNextUnrated();
    </script>
</body>
</html>
